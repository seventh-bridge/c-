# Qt UDP文件传输上位机技术文档

## 1. 项目概述

### 1.1 项目目标
开发一个基于Qt框架的UDP协议文件传输上位机软件，实现高速、可靠的文件传输功能，支持多线程异步处理，具备完善的错误处理和重传机制。

### 1.2 核心功能
- UDP协议文件传输
- 多线程并发处理
- 数据包校验和重传机制
- 异步日志更新
- 图形化用户界面
- 自动保存和手动保存功能

## 2. 技术架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   UI界面层      │    │   业务逻辑层    │    │   网络通信层    │
│                 │    │                 │    │                 │
│ • 参数配置      │◄──►│ • 文件管理      │◄──►│ • UDP通信       │
│ • 日志显示      │    │ • 协议处理      │    │ • 数据收发      │
│ • 控制按钮      │    │ • 线程管理      │    │ • 异步处理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 技术选型
- **UI框架**: Qt 6.x Widgets
- **网络库**: Qt Network模块 (QUdpSocket)
- **编程语言**: C++17
- **构建系统**: qmake
- **并发模型**: QtConcurrent + Qt信号槽机制

## 3. 核心模块设计

### 3.1 网络通信模块 (UdpTransport)

#### 3.1.1 UDP通信设计
- 使用Qt的`QUdpSocket`进行UDP通信
- 实现异步发送和接收：`writeDatagram`和`readyRead`信号
- 支持单播模式
- 配置socket缓冲区大小以优化性能

#### 3.1.2 主要接口
```cpp
class UdpTransport : public QObject
{
public:
    bool startListening(quint16 port);           // 开始监听
    void stopListening();                        // 停止监听
    void sendDatagram(const QByteArray& data,    // 发送数据报
                     const QHostAddress& address, 
                     quint16 port);
    void setRemoteEndpoint(const QString& ip, quint16 port); // 设置远程端点
};
```

### 3.2 协议处理模块 (ProtocolHandler)

#### 3.2.1 数据包结构设计
```
数据包格式：
┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│ 包头(24)│ 序号(4) │ 长度(4) │ 校验(4) │ 数据(N) │ 包尾(4) │
└─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
```

- **包头**: 固定标识，用于包识别 (8字节)
- **序号**: 数据包序列号，用于排序和重传 (4字节)
- **长度**: 数据部分长度 (4字节)
- **校验**: CRC32校验码 (4字节)
- **数据**: 实际传输数据 (N字节)
- **包尾**: 结束标识 (4字节)

#### 3.2.2 数据包校验机制
- 使用CRC32算法进行数据完整性校验
- 接收端校验失败时记录日志
- 维护接收窗口，确保数据完整性

#### 3.2.3 主要接口
```cpp
class ProtocolHandler : public QObject
{
public:
    QByteArray createDataPacket(quint32 sequence, const QByteArray& data); // 创建数据包
    bool validatePacket(const QByteArray& packet);                        // 验证数据包
    QPair<quint32, QByteArray> extractPacketData(const QByteArray& packet); // 提取数据
    void startFileTransfer(const QString& filename, quint64 file_size);   // 开始文件传输
    bool isFileComplete() const;                                          // 检查文件是否完整
    QByteArray getCompleteFile();                                         // 获取完整文件
};
```

### 3.3 文件传输模块 (FileManager)

#### 3.3.1 文件分片策略
- 大文件分片传输，每片对应一个数据包
- 分片大小默认1400字节（考虑以太网MTU）
- 记录文件元信息（文件名、大小等）

#### 3.3.2 主要接口
```cpp
class FileManager : public QObject
{
public:
    bool loadFile(const QString& filepath);                    // 加载文件
    bool saveFile(const QByteArray& data, const QString& filepath); // 保存文件
    QList<QByteArray> splitFile(int chunk_size = 1400);        // 分片文件
};
```

### 3.4 用户界面模块 (MainWindow)

#### 3.4.1 界面布局
```
┌─────────────────────────────────────────────────────────────┐
│                    UDP文件传输上位机                        │
├─────────────────────────────────────────────────────────────┤
│ 目标IP: [__________]  目标端口: [_____]  本地端口: [_____]  │
├─────────────────────────────────────────────────────────────┤
│ 保存路径: [____________________________________] [浏览]    │
├─────────────────────────────────────────────────────────────┤
│ [开始监听] [停止监听] [发送文件] [保存文件]                 │
├─────────────────────────────────────────────────────────────┤
│ 日志输出区域                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 2024-01-01 10:00:00 [INFO] 系统启动                     │ │
│ │ 2024-01-01 10:00:01 [INFO] 开始监听端口 8080            │ │
│ │ ...                                                     │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 3.4.2 控件功能说明
- **目标IP输入框**: 输入目标设备IP地址
- **目标端口输入框**: 输入目标设备端口号
- **本地端口输入框**: 输入本机监听端口号
- **保存路径输入框**: 输入文件自动保存目录
- **浏览按钮**: 选择保存目录
- **开始监听按钮**: 启动UDP监听服务
- **停止监听按钮**: 停止UDP监听服务
- **发送文件按钮**: 选择并发送文件
- **保存文件按钮**: 手动选择保存接收到的文件
- **日志输出区域**: 实时显示系统日志

## 4. 工作流程

### 4.1 文件发送流程
1. 用户点击"发送文件"按钮
2. 选择要发送的文件
3. 文件管理器加载文件并分片
4. 协议处理器为每个分片创建数据包
5. UDP传输模块发送数据包到目标地址
6. 显示发送进度

### 4.2 文件接收流程
1. 用户设置监听端口并开始监听
2. 接收到数据包后进行校验
3. 协议处理器验证数据包完整性
4. 按序列号存储接收到的数据包
5. 检查文件是否完整接收
6. 完整接收后自动保存到指定目录
7. 用户也可手动选择保存位置和文件名

## 5. 错误处理机制

### 5.1 网络错误处理
- 数据包校验失败记录日志
- 网络连接异常检测和恢复
- 超时处理机制

### 5.2 文件操作错误处理
- 文件读写权限检查
- 磁盘空间不足检测
- 文件完整性验证

### 5.3 系统异常恢复
- 内存泄漏检测和清理
- 系统状态自动恢复
- 日志记录异常信息

## 6. 性能优化策略

### 6.1 网络性能优化
- **Socket缓冲区优化**: 合理设置发送和接收缓冲区
- **批量发送**: 提高传输效率
- **异步IO**: 避免线程阻塞

### 6.2 内存管理优化
- 预分配内存减少动态分配
- QByteArray高效内存管理
- 及时释放不需要的数据

### 6.3 并发性能优化
- QtConcurrent异步文件操作
- 信号槽机制解耦模块间通信
- 避免UI线程阻塞

## 7. 编译和部署

### 7.1 编译环境要求
- **Qt版本**: Qt 6.2或更高版本
- **编译器**: 支持C++17的编译器
- **操作系统**: Windows 10/11, Linux, macOS

### 7.2 编译步骤
```bash
# 生成Makefile
qmake udp_file_transfer_qt.pro

# 编译
make  # Linux/macOS
# 或
nmake  # Windows
```

### 7.3 部署要求
- **运行环境**: Qt运行库
- **硬件要求**: 支持网络连接的计算机
- **网络要求**: UDP协议支持

## 8. 使用说明

### 8.1 基本操作流程
1. **配置网络参数**: 设置目标IP、目标端口、本地监听端口
2. **设置保存路径**: 选择文件自动保存目录
3. **启动监听**: 点击"开始监听"按钮
4. **发送文件**: 在另一实例中选择文件发送
5. **接收文件**: 自动保存到指定目录或手动保存

### 8.2 注意事项
- 确保网络连接正常
- 确保保存目录有写入权限
- 大文件传输时注意网络稳定性
- 及时查看日志信息了解传输状态

## 9. 扩展性设计

### 9.1 功能扩展
- 支持断点续传
- 增加传输速率统计
- 支持多文件批量传输

### 9.2 性能扩展
- 支持传输队列管理
- 动态调整分片大小
- 增加压缩传输功能

---

*文档版本: 1.0*
*最后更新: 2024年*